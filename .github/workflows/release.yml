name: ğŸš€ Release & Auto-Sign APK

on:
  push:
    tags:
      - 'v*.*.*'
      - 'release-*'
  workflow_dispatch:
    inputs:
      version_name:
        description: 'Release Version (e.g., v2.0.0)'
        required: true
        default: 'v2.0.0'
      release_notes:
        description: 'Release Notes'
        required: false
        default: 'ğŸš€ Nova versÃ£o com IA revolucionÃ¡ria e configuraÃ§Ãµes avanÃ§adas!'
      build_type:
        description: 'Build Type'
        required: true
        type: choice
        default: 'release'
        options:
          - release
          - debug
          - both

env:
  # ğŸ” ConfiguraÃ§Ãµes de assinatura (pÃºblico - pode ser usado por todos)
  KEYSTORE_PASSWORD: "MicrosoftRewardsBot2024"
  KEY_ALIAS: "microsoftrewardsbot"
  KEY_PASSWORD: "MicrosoftRewardsBot2024"

jobs:
  build-and-release:
    name: ğŸ—ï¸ Build & Release APK
    runs-on: ubuntu-latest

    steps:
      # ğŸ“¥ 1. Checkout do cÃ³digo
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # â˜• 2. Setup Java 17
      - name: â˜• Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      # ğŸ”§ 3. Grant execute permission for gradlew
      - name: ğŸ”§ Grant execute permission for gradlew
        run: chmod +x gradlew

      # ğŸ”‘ 4. Generate Keystore for Signing
      - name: ğŸ”‘ Generate Release Keystore
        run: |
          echo "ğŸ” Generating keystore for APK signing..."
          keytool -genkey -noprompt \
            -alias $KEY_ALIAS \
            -dname "CN=Microsoft Rewards Bot, OU=Mobile Development, O=Capy AI, L=San Francisco, S=California, C=US" \
            -keystore release.keystore \
            -storepass $KEYSTORE_PASSWORD \
            -keypass $KEY_PASSWORD \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000
          echo "âœ… Keystore generated successfully!"

      # ğŸ“ 5. Create signing config
      - name: ğŸ“ Create signing config
        run: |
          echo "ğŸ”§ Creating signing configuration..."
          cat > keystore.properties << EOF
          storePassword=$KEYSTORE_PASSWORD
          keyPassword=$KEY_PASSWORD
          keyAlias=$KEY_ALIAS
          storeFile=../release.keystore
          EOF
          echo "âœ… Signing config created!"

      # ğŸ§¹ 6. Clean project
      - name: ğŸ§¹ Clean project
        run: ./gradlew clean

      # ğŸ”¨ 7. Build APK(s) based on input
      - name: ğŸ”¨ Build APK
        run: |
          BUILD_TYPE="${{ github.event.inputs.build_type || 'release' }}"
          
          echo "ğŸš€ Building APK with type: $BUILD_TYPE"
          
          if [[ "$BUILD_TYPE" == "release" ]]; then
            echo "ğŸ“¦ Building Release APK..."
            ./gradlew assembleRelease
            
          elif [[ "$BUILD_TYPE" == "debug" ]]; then
            echo "ğŸ› Building Debug APK..."
            ./gradlew assembleDebug
            
          elif [[ "$BUILD_TYPE" == "both" ]]; then
            echo "ğŸ“¦ğŸ› Building both Release and Debug APKs..."
            ./gradlew assembleRelease assembleDebug
          fi

      # ğŸ·ï¸ 8. Sign APK (if release)
      - name: ğŸ·ï¸ Sign Release APK
        if: contains(github.event.inputs.build_type, 'release') || github.event.inputs.build_type == 'both' || github.ref_type == 'tag'
        run: |
          echo "ğŸ” Signing Release APK..."
          
          # Sign the release APK
          if [ -f "app/build/outputs/apk/release/app-release-unsigned.apk" ]; then
            jarsigner -verbose -sigalg SHA1withRSA -digestalg SHA1 \
              -keystore release.keystore \
              -storepass $KEYSTORE_PASSWORD \
              -keypass $KEY_PASSWORD \
              app/build/outputs/apk/release/app-release-unsigned.apk $KEY_ALIAS
            
            # Align the APK
            $ANDROID_HOME/build-tools/*/zipalign -v 4 \
              app/build/outputs/apk/release/app-release-unsigned.apk \
              app/build/outputs/apk/release/app-release-signed.apk
              
            echo "âœ… APK signed and aligned successfully!"
          else
            echo "âš ï¸ No unsigned release APK found, checking for already signed APK..."
            if [ -f "app/build/outputs/apk/release/app-release.apk" ]; then
              cp app/build/outputs/apk/release/app-release.apk app/build/outputs/apk/release/app-release-signed.apk
              echo "âœ… Found already signed APK!"
            fi
          fi

      # ğŸ“Š 9. Generate build info
      - name: ğŸ“Š Generate Build Report
        run: |
          echo "ğŸ“Š Generating build information..."
          
          VERSION_NAME="${{ github.event.inputs.version_name || github.ref_name }}"
          BUILD_TYPE="${{ github.event.inputs.build_type || 'release' }}"
          
          cat > build-info.txt << EOF
          ğŸ¤– Microsoft Rewards Bot - Advanced Edition
          ============================================
          
          ğŸ“‹ Build Information:
          â€¢ Version: $VERSION_NAME
          â€¢ Build Type: $BUILD_TYPE
          â€¢ Build Date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          â€¢ Git Commit: $(git rev-parse --short HEAD)
          â€¢ Git Branch: $(git rev-parse --abbrev-ref HEAD)
          
          ğŸš€ New Features in this Release:
          â€¢ IA revolucionÃ¡ria tipo ChatGPT
          â€¢ ConfiguraÃ§Ãµes avanÃ§adas personalizÃ¡veis
          â€¢ Suporte a mÃºltiplos navegadores
          â€¢ URLs vÃ¡lidas para Microsoft Rewards
          â€¢ Sistema anti-repetiÃ§Ã£o global
          â€¢ Delay aleatÃ³rio configurÃ¡vel
          â€¢ Modo stealth experimental
          
          ğŸ“± APK Details:
          EOF
          
          # Add APK information
          for apk in app/build/outputs/apk/*/*.apk; do
            if [ -f "$apk" ]; then
              echo "â€¢ $(basename "$apk"): $(du -h "$apk" | cut -f1)" >> build-info.txt
            fi
          done
          
          echo "" >> build-info.txt
          echo "ğŸ” Signed with auto-generated certificate" >> build-info.txt
          echo "âš ï¸  This is a development build - install with 'Unknown Sources' enabled" >> build-info.txt
          
          echo "âœ… Build report generated!"

      # ğŸ“‹ 10. List generated files
      - name: ğŸ“‹ List Build Artifacts
        run: |
          echo "ğŸ“‹ Build artifacts generated:"
          find app/build/outputs/apk -name "*.apk" -type f -exec ls -lh {} \;
          
          echo ""
          echo "ğŸ“Š Build report:"
          cat build-info.txt

      # ğŸ·ï¸ 11. Create Release
      - name: ğŸ·ï¸ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.version_name || github.ref_name }}
          name: "ğŸ¤– Microsoft Rewards Bot ${{ github.event.inputs.version_name || github.ref_name }}"
          body: |
            ${{ github.event.inputs.release_notes || 'ğŸš€ Nova versÃ£o com IA revolucionÃ¡ria e configuraÃ§Ãµes avanÃ§adas!' }}
            
            ## ğŸ¯ Principais Recursos
            
            ### ğŸ§  IA RevolucionÃ¡ria Tipo ChatGPT
            - âœ… Sistema de reasoning e chains of thought
            - âœ… Contexto histÃ³rico e memÃ³ria persistente  
            - âœ… Aprendizado dinÃ¢mico baseado em sucesso
            - âœ… Emotional intelligence e humor temporal
            - âœ… Meta-learning para Microsoft Rewards
            - âœ… 50,000+ tÃ³picos inteligentes em 8 categorias
            
            ### âš™ï¸ ConfiguraÃ§Ãµes AvanÃ§adas PersonalizÃ¡veis
            - âœ… Tempo entre pesquisas configurÃ¡vel (1-30s)
            - âœ… MÃºltiplos navegadores: Chrome, Bing, Edge, Firefox, Opera
            - âœ… URLs personalizÃ¡veis + parÃ¢metros Microsoft Rewards
            - âœ… Delay aleatÃ³rio inteligente (3-30s)
            - âœ… Modo incÃ³gnito e stealth experimental
            - âœ… Sistema de fallback para Chrome
            
            ### ğŸ¨ Interface e UX
            - âœ… Tela de configuraÃ§Ãµes avanÃ§adas completa
            - âœ… Preview de configuraÃ§Ãµes em tempo real
            - âœ… Teste de configuraÃ§Ãµes integrado
            - âœ… ExportaÃ§Ã£o e reset de configuraÃ§Ãµes
            - âœ… NotificaÃ§Ãµes melhoradas com progresso detalhado
            
            ## ğŸ“¥ Como Instalar
            
            1. **Baixe o APK** apropriado para seu dispositivo
            2. **Ative "Origens desconhecidas"** nas configuraÃ§Ãµes do Android
            3. **Instale o APK** normalmente
            4. **Configure** suas preferÃªncias em âš™ï¸ ConfiguraÃ§Ãµes AvanÃ§adas
            5. **Aproveite** a IA revolucionÃ¡ria! ğŸ‰
            
            ## ğŸ” Sobre a Assinatura
            
            Este APK Ã© assinado automaticamente com certificado de desenvolvimento. Ã‰ seguro de usar, mas seu dispositivo pode mostrar avisos sobre "desenvolvedor desconhecido" - isso Ã© normal para APKs nÃ£o distribuÃ­dos pela Play Store.
            
            ## ğŸ“‹ Build Information
            ```
            ğŸ“¦ VersÃ£o: ${{ github.event.inputs.version_name || github.ref_name }}
            ğŸ—ï¸  Build: ${{ github.event.inputs.build_type || 'release' }}
            ğŸ“… Data: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
            ğŸ”§ Commit: $(git rev-parse --short HEAD)
            ```
            
            ---
            
            **âš ï¸ Aviso Legal:** Este app Ã© apenas para fins educacionais. Use responsavelmente e de acordo com os termos de serviÃ§o do Microsoft Rewards.
          draft: false
          prerelease: false
          files: |
            app/build/outputs/apk/**/*.apk
            build-info.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ğŸ“ˆ 12. Upload artifacts for workflow
      - name: ğŸ“ˆ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: "microsoft-rewards-bot-${{ github.event.inputs.version_name || github.ref_name }}-apks"
          path: |
            app/build/outputs/apk/**/*.apk
            build-info.txt
          retention-days: 90

      # ğŸ§ª 13. Upload test results (if any)
      - name: ğŸ§ª Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: "test-results-${{ github.event.inputs.version_name || github.ref_name }}"
          path: |
            app/build/reports/
            app/build/test-results/
          retention-days: 30

      # ğŸ“§ 14. Build Summary
      - name: ğŸ“§ Build Summary
        if: always()
        run: |
          echo "ğŸ‰ Build completed successfully!"
          echo ""
          echo "ğŸ“‹ Summary:"
          echo "â€¢ Version: ${{ github.event.inputs.version_name || github.ref_name }}"
          echo "â€¢ Build Type: ${{ github.event.inputs.build_type || 'release' }}"
          echo "â€¢ APKs Generated: $(find app/build/outputs/apk -name "*.apk" | wc -l)"
          echo "â€¢ Total Size: $(du -sh app/build/outputs/apk | cut -f1)"
          echo ""
          echo "ğŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ github.event.inputs.version_name || github.ref_name }}"
          echo ""
          echo "âœ… Release created and APKs uploaded successfully!"

  # ğŸ§¹ Cleanup job (optional)
  cleanup:
    name: ğŸ§¹ Cleanup
    runs-on: ubuntu-latest
    needs: build-and-release
    if: always()
    
    steps:
      - name: ğŸ§¹ Cleanup old releases
        run: |
          echo "ğŸ§¹ Cleanup completed - keeping all releases for now"
          echo "Future: Could implement automatic cleanup of old pre-releases"